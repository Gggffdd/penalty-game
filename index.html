<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Пенальти Мастер</title>
    
    <!-- PWA-настройки -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1E88E5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            position: fixed;
            width: 100%;
            height: 100%;
            background: #87CEEB;
            -webkit-font-smoothing: antialiased;
        }
        
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #87CEEB 50%, #2E8B57 50%);
        }
        
        #uiContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #scoreDisplay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        #messageDisplay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: yellow;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            opacity: 0;
            transition: opacity 0.3s;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 15px 30px;
            border-radius: 10px;
            max-width: 90%;
        }
        
        #powerBar {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 400px;
            height: 25px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            overflow: hidden;
            display: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        #powerFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #00ff00, #ffff00, #ff0000);
            transition: width 0.05s linear;
        }
        
        #powerText {
            position: absolute;
            top: -30px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }
        
        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.3s;
        }
        
        #menu h1 {
            color: #FFD700;
            font-size: 42px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            text-align: center;
            padding: 0 20px;
        }
        
        .menu-btn {
            width: 80%;
            max-width: 300px;
            padding: 15px;
            margin: 10px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            background-color: #1a6bff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, background-color 0.2s;
        }
        
        .menu-btn:hover {
            background-color: #1a5bdf;
        }
        
        .menu-btn:active {
            transform: scale(0.95);
        }
        
        .difficulty-btn {
            background-color: #333;
        }
        
        .difficulty-btn:hover {
            background-color: #444;
        }
        
        .difficulty-btn.selected {
            background-color: #1E88E5;
            box-shadow: 0 0 10px rgba(30, 136, 229, 0.7);
        }
        
        #startBtn {
            background-color: #28a745;
            margin-top: 30px;
        }
        
        #startBtn:hover {
            background-color: #218838;
        }
        
        #resultScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        #resultTitle {
            color: #FFD700;
            font-size: 42px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
        
        #resultScore {
            color: white;
            font-size: 28px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        #resultRating {
            color: #ffcc00;
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
            line-height: 1.4;
        }
        
        #restartBtn, #menuBtn {
            width: 80%;
            max-width: 300px;
            padding: 15px;
            margin: 10px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
        }
        
        #restartBtn {
            background-color: #1a6bff;
        }
        
        #restartBtn:hover {
            background-color: #1a5bdf;
        }
        
        #restartBtn:active {
            transform: scale(0.95);
        }
        
        #menuBtn {
            background-color: #6c757d;
        }
        
        #menuBtn:hover {
            background-color: #5a6268;
        }
        
        #menuBtn:active {
            transform: scale(0.95);
        }
        
        #tutorial {
            color: white;
            font-size: 16px;
            text-align: center;
            margin-top: 20px;
            max-width: 80%;
            line-height: 1.4;
            opacity: 0.8;
        }
        
        #attemptsLeft {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        .goal-net {
            position: absolute;
            width: 300px;
            height: 200px;
            background: repeating-linear-gradient(
                0deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.1) 1px,
                transparent 1px,
                transparent 10px
            ), repeating-linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.1) 1px,
                transparent 1px,
                transparent 10px
            );
            pointer-events: none;
        }
        
        #debugInfo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 3px;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="uiContainer">
        <div id="scoreDisplay">Голы: 0/0</div>
        <div id="attemptsLeft">Осталось: 5</div>
        <div id="messageDisplay"></div>
        <div id="powerBar">
            <div id="powerText">Сила удара: 0%</div>
            <div id="powerFill"></div>
        </div>
        <div id="debugInfo"></div>
    </div>
    
    <div id="menu">
        <h1>ПЕНАЛЬТИ МАСТЕР</h1>
        <button class="menu-btn difficulty-btn selected" data-difficulty="easy">ЛЁГКИЙ</button>
        <button class="menu-btn difficulty-btn" data-difficulty="medium">СРЕДНИЙ</button>
        <button class="menu-btn difficulty-btn" data-difficulty="hard">СЛОЖНЫЙ</button>
        <button class="menu-btn" id="startBtn">НАЧАТЬ ИГРУ</button>
        <div id="tutorial">
            Проведите пальцем по мячу, чтобы ударить. Чем длиннее свайп, тем сильнее удар.
            Попробуйте обмануть вратаря, выбирая разные углы!
        </div>
    </div>
    
    <div id="resultScreen">
        <h2 id="resultTitle">РЕЗУЛЬТАТ</h2>
        <div id="resultScore">Ваш счет: 0 из 5</div>
        <div id="resultRating"></div>
        <button id="restartBtn">ИГРАТЬ СНОВА</button>
        <button id="menuBtn">ГЛАВНОЕ МЕНЮ</button>
    </div>

    <script>
        // Константы
        const GOAL_BLUE = '#1976D2';
        const MAX_ATTEMPTS = 5;
        const BALL_FRICTION = 0.98;
        const BALL_GRAVITY = 0.2;
        const BALL_BOUNCE = 0.7;
        const GOALKEEPER_REACTION_DELAY = 0.3; // секунды
        
        // Инициализация элементов
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const attemptsLeftDisplay = document.getElementById('attemptsLeft');
        const messageDisplay = document.getElementById('messageDisplay');
        const powerBar = document.getElementById('powerBar');
        const powerFill = document.getElementById('powerFill');
        const powerText = document.getElementById('powerText');
        const menu = document.getElementById('menu');
        const difficultyBtns = document.querySelectorAll('.difficulty-btn');
        const startBtn = document.getElementById('startBtn');
        const resultScreen = document.getElementById('resultScreen');
        const resultScore = document.getElementById('resultScore');
        const resultRating = document.getElementById('resultRating');
        const restartBtn = document.getElementById('restartBtn');
        const menuBtn = document.getElementById('menuBtn');
        const debugInfo = document.getElementById('debugInfo');
        const tutorial = document.getElementById('tutorial');

        // Размеры canvas
        let canvasWidth, canvasHeight;
        
        // Игровые переменные
        let gameState = 'menu';
        let difficulty = 'easy';
        let score = 0;
        let attempts = 0;
        let power = 0;
        let isCharging = false;
        let chargeStartTime = 0;
        let chargeInterval;
        let lastFrameTime = 0;
        let deltaTime = 0;
        let debugMode = false;
        let showTutorial = true;
        
        // Игровые объекты
        const ball = {
            x: 0, y: 0, radius: 15,
            speedX: 0, speedY: 0,
            moving: false, scored: false, saved: false,
            lastBounceTime: 0
        };
        
        const goalkeeper = {
            x: 0, y: 100, width: 80, height: 120,
            speed: 3, direction: 1, moving: true,
            reactionDelay: GOALKEEPER_REACTION_DELAY,
            reactionTimer: 0,
            targetX: 0,
            diving: false,
            diveSpeed: 0,
            diveDirection: 0
        };
        
        const goal = {
            x: 0, y: 150, width: 300, height: 200,
            leftPost: 0, rightPost: 0, crossbar: 0
        };
        
        // Частицы
        let particles = [];
        
        // Звуки
        const sounds = {
            kick: null,
            goal: null,
            save: null,
            bounce: null,
            crowd: null,
            whistle: null
        };
        
        // Создаем AudioContext
        let audioContext;
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.log('Web Audio API не поддерживается');
        }

        // Основные функции
        function resizeCanvas() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Позиционируем мяч
            ball.x = canvasWidth / 2;
            ball.y = canvasHeight - 150;
            
            // Позиционируем ворота
            goal.x = canvasWidth / 2 - goal.width / 2;
            goal.leftPost = goal.x;
            goal.rightPost = goal.x + goal.width;
            goal.crossbar = goal.y;
            
            // Позиционируем вратаря
            goalkeeper.x = canvasWidth / 2 - goalkeeper.width / 2;
            goalkeeper.y = goal.y + 30;
            
            if (gameState === 'playing') draw();
        }
        
        function initGame() {
            score = 0;
            attempts = 0;
            updateScoreDisplay();
            startAttempt();
            
            // Инициализация звуков
            initSounds();
        }
        
        function initSounds() {
            if (!audioContext) return;
            
            // Простые звуки с использованием Web Audio API
            sounds.kick = createSound(150, 'sawtooth', 0.2, 0.02);
            sounds.goal = createSound(300, 'square', 0.3, 0.5);
            sounds.save = createSound(100, 'sine', 0.2, 0.1);
            sounds.bounce = createSound(80, 'sine', 0.1, 0.01);
            sounds.whistle = createSound(800, 'sine', 0.5, 0.3);
        }
        
        function createSound(freq, type, vol, duration) {
            return function() {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = type;
                oscillator.frequency.value = freq;
                gainNode.gain.value = vol;
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                oscillator.stop(audioContext.currentTime + duration);
            };
        }
        
        function playSound(sound) {
            if (sound && audioContext) {
                try {
                    sound();
                } catch (e) {
                    console.error('Ошибка воспроизведения звука:', e);
                }
            }
        }
        
        function startAttempt() {
            if (attempts >= MAX_ATTEMPTS) {
                endGame();
                return;
            }
            
            attempts++;
            updateScoreDisplay();
            
            // Сброс мяча
            resetBall();
            
            // Сброс вратаря
            resetGoalkeeper();
            
            // Показываем шкалу силы
            powerBar.style.display = 'block';
            power = 0;
            updatePowerBar();
            
            // Сообщение
            showMessage(`Пенальти ${attempts}/${MAX_ATTEMPTS}`, 60);
        }
        
        function resetBall() {
            ball.x = canvasWidth / 2;
            ball.y = canvasHeight - 150;
            ball.speedX = 0;
            ball.speedY = 0;
            ball.moving = false;
            ball.scored = false;
            ball.saved = false;
            ball.lastBounceTime = 0;
        }
        
        function resetGoalkeeper() {
            goalkeeper.x = canvasWidth / 2 - goalkeeper.width / 2;
            goalkeeper.y = goal.y + 30;
            goalkeeper.moving = true;
            goalkeeper.direction = Math.random() > 0.5 ? 1 : -1;
            goalkeeper.diving = false;
            goalkeeper.reactionTimer = 0;
            
            // Настройка сложности
            switch (difficulty) {
                case 'easy':
                    goalkeeper.speed = 2;
                    goalkeeper.reactionDelay = GOALKEEPER_REACTION_DELAY * 1.5;
                    break;
                case 'medium':
                    goalkeeper.speed = 3;
                    goalkeeper.reactionDelay = GOALKEEPER_REACTION_DELAY;
                    break;
                case 'hard':
                    goalkeeper.speed = 4;
                    goalkeeper.reactionDelay = GOALKEEPER_REACTION_DELAY * 0.7;
                    break;
            }
        }
        
        function updateScoreDisplay() {
            scoreDisplay.textContent = `Голы: ${score}/${attempts}`;
            attemptsLeftDisplay.textContent = `Осталось: ${MAX_ATTEMPTS - attempts}`;
        }
        
        function showMessage(text, duration = 120) {
            messageDisplay.textContent = text;
            messageDisplay.style.opacity = '1';
            
            clearTimeout(messageDisplay.timeout);
            messageDisplay.timeout = setTimeout(() => {
                messageDisplay.style.opacity = '0';
            }, duration * 16);
        }
        
        function updatePowerBar() {
            powerFill.style.width = `${power}%`;
            powerText.textContent = `Сила удара: ${Math.round(power)}%`;
            
            // Изменение цвета текста в зависимости от силы
            if (power < 30) {
                powerText.style.color = '#00ff00';
            } else if (power < 70) {
                powerText.style.color = '#ffff00';
            } else {
                powerText.style.color = '#ff0000';
            }
        }
        
        function startCharging() {
            if (ball.moving || isCharging) return;
            
            isCharging = true;
            chargeStartTime = Date.now();
            
            chargeInterval = setInterval(() => {
                const elapsed = Date.now() - chargeStartTime;
                power = Math.min(elapsed / 5, 100);
                updatePowerBar();
                
                if (power >= 100) {
                    clearInterval(chargeInterval);
                    setTimeout(() => {
                        if (isCharging) {
                            kickBall(power);
                        }
                    }, 100);
                }
            }, 16);
        }
        
        function stopCharging() {
            if (!isCharging) return;
            
            clearInterval(chargeInterval);
            isCharging = false;
            
            if (power > 10) { // Минимальная сила удара
                kickBall(power);
            } else {
                power = 0;
                updatePowerBar();
            }
        }
        
        function kickBall(power) {
            if (ball.moving) return;
            
            // Определяем направление удара (от свайпа или автоматически)
            let angle;
            let force;
            
            if (swipeVector) {
                // Используем вектор свайпа
                const swipeLength = Math.sqrt(swipeVector.x * swipeVector.x + swipeVector.y * swipeVector.y);
                force = Math.min(swipeLength / 2, 15) * (power / 100);
                
                // Нормализуем вектор
                angle = Math.atan2(-swipeVector.y, swipeVector.x);
                
                // Ограничиваем угол, чтобы мяч летел в основном вперед
                const maxAngle = Math.PI / 3; // 60 градусов вверх
                angle = Math.max(-maxAngle, Math.min(angle, maxAngle));
                
                // Добавляем немного случайности
                angle += (Math.random() - 0.5) * 0.2;
            } else {
                // Автоматический удар (если свайпа не было)
                force = 10 * (power / 100);
                angle = -Math.PI / 4 + (Math.random() - 0.5) * 0.3;
            }
            
            ball.speedX = Math.cos(angle) * force;
            ball.speedY = Math.sin(angle) * force;
            ball.moving = true;
            
            // Скрываем шкалу силы
            powerBar.style.display = 'none';
            
            // Вратарь начинает реагировать
            goalkeeper.reactionTimer = goalkeeper.reactionDelay;
            
            // Звук удара
            playSound(sounds.kick);
            
            // Эффект частиц
            createParticles(ball.x, ball.y, 10, '#FFFFFF');
            
            // Сброс свайпа
            swipeVector = null;
        }
        
        function update() {
            const currentTime = Date.now();
            deltaTime = (currentTime - lastFrameTime) / 1000;
            lastFrameTime = currentTime;
            
            // Обновление вратаря
            updateGoalkeeper();
            
            // Обновление мяча
            if (ball.moving) {
                updateBall();
            }
            
            // Обновление частиц
            updateParticles();
            
            // Отладка
            if (debugMode) {
                debugInfo.textContent = `Ball: (${ball.x.toFixed(1)}, ${ball.y.toFixed(1)})\n` +
                                      `Speed: (${ball.speedX.toFixed(1)}, ${ball.speedY.toFixed(1)})\n` +
                                      `State: ${ball.moving ? 'moving' : 'still'}\n` +
                                      `FPS: ${Math.round(1 / deltaTime)}`;
            }
        }
        
        function updateGoalkeeper() {
            if (!ball.moving || goalkeeper.diving) return;
            
            // Вратарь ждет некоторое время перед реакцией
            if (goalkeeper.reactionTimer > 0) {
                goalkeeper.reactionTimer -= deltaTime;
                return;
            }
            
            // Определяем, в какую сторону прыгать
            const ballToGoalX = ball.x - (goal.x + goal.width / 2);
            const predictX = ball.x + ball.speedX * 0.5;
            
            // Решаем, прыгать ли вратарю
            if (!goalkeeper.diving && Math.abs(predictX - (goalkeeper.x + goalkeeper.width / 2)) > 50) {
                goalkeeper.diving = true;
                goalkeeper.diveDirection = predictX < (goalkeeper.x + goalkeeper.width / 2) ? -1 : 1;
                goalkeeper.diveSpeed = 15 + Math.random() * 5;
                
                // Добавляем немного случайности в прыжок
                setTimeout(() => {
                    if (Math.random() < 0.3) { // 30% шанс ошибки вратаря
                        goalkeeper.diveDirection *= -1;
                    }
                }, 100);
            }
            
            // Если вратарь в прыжке
            if (goalkeeper.diving) {
                goalkeeper.x += goalkeeper.diveSpeed * goalkeeper.diveDirection * deltaTime * 60;
                goalkeeper.diveSpeed *= 0.95;
                
                if (Math.abs(goalkeeper.diveSpeed) < 0.5) {
                    goalkeeper.diving = false;
                }
            }
        }
        
        function updateBall() {
            // Применяем гравитацию
            ball.speedY += BALL_GRAVITY;
            
            // Применяем трение
            ball.speedX *= BALL_FRICTION;
            ball.speedY *= BALL_FRICTION;
            
            // Обновляем позицию
            ball.x += ball.speedX;
            ball.y += ball.speedY;
            
            // Проверка столкновений с границами
            if (ball.x - ball.radius < 0) {
                ball.x = ball.radius;
                ball.speedX *= -BALL_BOUNCE;
                createParticles(ball.x, ball.y, 5, '#FFFFFF');
                playSound(sounds.bounce);
            } else if (ball.x + ball.radius > canvasWidth) {
                ball.x = canvasWidth - ball.radius;
                ball.speedX *= -BALL_BOUNCE;
                createParticles(ball.x, ball.y, 5, '#FFFFFF');
                playSound(sounds.bounce);
            }
            
            // Проверка столкновения с землей
            if (ball.y + ball.radius > canvasHeight) {
                ball.y = canvasHeight - ball.radius;
                ball.speedY *= -BALL_BOUNCE * 0.7;
                ball.speedX *= 0.8;
                
                // Проверяем, не остановился ли мяч
                if (Math.abs(ball.speedY) < 0.5 && Date.now() - ball.lastBounceTime > 500) {
                    ball.moving = false;
                    ball.saved = true;
                    showMessage('Промах!', 60);
                    setTimeout(startAttempt, 1500);
                    return;
                }
                
                createParticles(ball.x, ball.y, 10, '#2E8B57');
                playSound(sounds.bounce);
                ball.lastBounceTime = Date.now();
            }
            
            // Проверка столкновения с вратарем
            if (!ball.scored && !ball.saved &&
                ball.x + ball.radius > goalkeeper.x &&
                ball.x - ball.radius < goalkeeper.x + goalkeeper.width &&
                ball.y + ball.radius > goalkeeper.y &&
                ball.y - ball.radius < goalkeeper.y + goalkeeper.height) {
                
                // Мяч отбит
                ball.speedX = (ball.x - (goalkeeper.x + goalkeeper.width / 2)) * 0.2;
                ball.speedY = -Math.abs(ball.speedY) * 0.5;
                ball.saved = true;
                
                // Эффекты
                createParticles(ball.x, ball.y, 15, '#1E88E5');
                playSound(sounds.save);
                showMessage('Сейв!', 60);
                
                setTimeout(startAttempt, 1500);
            }
            
            // Проверка гола
            if (!ball.scored && !ball.saved &&
                ball.y + ball.radius < goal.crossbar &&
                ball.x - ball.radius > goal.leftPost &&
                ball.x + ball.radius < goal.rightPost) {
                
                ball.scored = true;
                score++;
                updateScoreDisplay();
                
                // Эффекты
                createParticles(ball.x, ball.y, 20, '#FFD700');
                playSound(sounds.goal);
                showMessage('ГОООЛ!!!', 90);
                
                setTimeout(startAttempt, 2000);
            }
            
            // Если мяч улетел за пределы экрана сверху
            if (ball.y + ball.radius < 0) {
                ball.moving = false;
                ball.saved = true;
                showMessage('Мимо!', 60);
                setTimeout(startAttempt, 1500);
            }
        }
        
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 5 + 2,
                    speedX: (Math.random() - 0.5) * 6,
                    speedY: (Math.random() - 0.5) * 6,
                    color: color,
                    life: 30 + Math.random() * 30,
                    opacity: 1
                });
            }
        }
        
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                
                p.x += p.speedX;
                p.y += p.speedY;
                p.speedY += 0.1;
                p.life--;
                p.opacity = p.life / 60;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }
        
        function draw() {
            // Очистка
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // Фон
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight / 2);
            ctx.fillStyle = '#2E8B57';
            ctx.fillRect(0, canvasHeight / 2, canvasWidth, canvasHeight / 2);
            
            // Разметка поля
            drawFieldMarkings();
            
            // Ворота
            drawGoal();
            
            // Вратарь
            drawGoalkeeper();
            
            // Мяч
            drawBall();
            
            // Частицы
            drawParticles();
        }
        
        function drawFieldMarkings() {
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            
            // Центральная линия
            ctx.beginPath();
            ctx.moveTo(0, canvasHeight / 2);
            ctx.lineTo(canvasWidth, canvasHeight / 2);
            ctx.stroke();
            
            // Центральный круг
            ctx.beginPath();
            ctx.arc(canvasWidth / 2, canvasHeight / 2, 70, 0, Math.PI * 2);
            ctx.stroke();
            
            // Вратарская площадка
            ctx.beginPath();
            ctx.rect(canvasWidth / 2 - 100, canvasHeight - 150, 200, 50);
            ctx.stroke();
            
            // Точка для пенальти
            ctx.beginPath();
            ctx.arc(canvasWidth / 2, canvasHeight - 100, 5, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
        }
        
        function drawGoal() {
            // Сетка ворот
            ctx.fillStyle = 'rgba(25, 118, 210, 0.3)';
            ctx.fillRect(goal.x, goal.y, goal.width, goal.height);
            
            // Рамка ворот
            ctx.strokeStyle = GOAL_BLUE;
            ctx.lineWidth = 5;
            
            // Левая штанга
            ctx.beginPath();
            ctx.moveTo(goal.leftPost, goal.crossbar);
            ctx.lineTo(goal.leftPost, goal.crossbar + goal.height);
            ctx.stroke();
            
            // Правая штанга
            ctx.beginPath();
            ctx.moveTo(goal.rightPost, goal.crossbar);
            ctx.lineTo(goal.rightPost, goal.crossbar + goal.height);
            ctx.stroke();
            
            // Перекладина
            ctx.beginPath();
            ctx.moveTo(goal.leftPost, goal.crossbar);
            ctx.lineTo(goal.rightPost, goal.crossbar);
            ctx.stroke();
            
            // Сетка ворот (линии)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            
            // Вертикальные линии
            const verticalLines = 6;
            for (let i = 1; i < verticalLines; i++) {
                const x = goal.x + (goal.width / verticalLines) * i;
                ctx.beginPath();
                ctx.moveTo(x, goal.y);
                ctx.lineTo(x, goal.y + goal.height);
                ctx.stroke();
            }
            
            // Горизонтальные линии
            const horizontalLines = 4;
            for (let i = 1; i < horizontalLines; i++) {
                const y = goal.y + (goal.height / horizontalLines) * i;
                ctx.beginPath();
                ctx.moveTo(goal.x, y);
                ctx.lineTo(goal.x + goal.width, y);
                ctx.stroke();
            }
        }
        
        function drawGoalkeeper() {
            ctx.fillStyle = '#1E88E5';
            
            // Тело
            ctx.beginPath();
            ctx.roundRect(goalkeeper.x, goalkeeper.y, goalkeeper.width, goalkeeper.height, [0, 0, 20, 20]);
            ctx.fill();
            
            // Голова
            ctx.fillStyle = '#FFD699';
            ctx.beginPath();
            ctx.arc(
                goalkeeper.x + goalkeeper.width / 2,
                goalkeeper.y - 15,
                20,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Глаза
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(
                goalkeeper.x + goalkeeper.width / 2 - 8,
                goalkeeper.y - 20,
                3,
                0,
                Math.PI * 2
            );
            ctx.arc(
                goalkeeper.x + goalkeeper.width / 2 + 8,
                goalkeeper.y - 20,
                3,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Руки (анимация при прыжке)
            ctx.fillStyle = '#1E88E5';
            if (goalkeeper.diving) {
                const armX = goalkeeper.diveDirection > 0 ? 
                    goalkeeper.x + goalkeeper.width : 
                    goalkeeper.x;
                
                ctx.beginPath();
                ctx.ellipse(
                    armX,
                    goalkeeper.y + 40,
                    15,
                    30,
                    0,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            }
        }
        
        function drawBall() {
            // Тень
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.ellipse(
                ball.x,
                canvasHeight - ball.radius / 2,
                ball.radius * 0.8,
                ball.radius * 0.3,
                0,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Мяч
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Черные пятиугольники (упрощенная текстура футбольного мяча)
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 1;
            
            // Центральная линия
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius * 0.9, 0, Math.PI * 2);
            ctx.stroke();
            
            // Несколько линий для текстуры
            for (let i = 0; i < 5; i++) {
                const angle = (i / 5) * Math.PI * 2;
                ctx.beginPath();
                ctx.moveTo(
                    ball.x + Math.cos(angle) * ball.radius * 0.3,
                    ball.y + Math.sin(angle) * ball.radius * 0.3
                );
                ctx.lineTo(
                    ball.x + Math.cos(angle) * ball.radius * 0.9,
                    ball.y + Math.sin(angle) * ball.radius * 0.9
                );
                ctx.stroke();
            }
        }
        
        function drawParticles() {
            for (const p of particles) {
                ctx.fillStyle = `${p.color.replace(')', `, ${p.opacity})`).replace('rgb', 'rgba')}`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function endGame() {
            gameState = 'result';
            resultScreen.style.display = 'flex';
            
            // Обновляем результаты
            resultScore.textContent = `Ваш счет: ${score} из ${MAX_ATTEMPTS}`;
            
            // Оценка результата
            let rating, comment;
            const ratio = score / MAX_ATTEMPTS;
            
            if (ratio >= 0.8) {
                rating = 'Великолепно!';
                comment = 'Вы настоящий мастер пенальти!';
            } else if (ratio >= 0.6) {
                rating = 'Хорошо!';
                comment = 'Отличный результат, почти профессионал!';
            } else if (ratio >= 0.4) {
                rating = 'Неплохо';
                comment = 'Нужно еще немного потренироваться';
            } else {
                rating = 'Попробуйте еще';
                comment = 'Не расстраивайтесь, у вас все получится!';
            }
            
            resultRating.textContent = `${rating}\n${comment}`;
            
            // Свисток
            playSound(sounds.whistle);
        }
        
        // Обработчики касаний/кликов
        let touchStartX, touchStartY;
        let swipeVector = null;
        
        function handleTouchStart(e) {
            if (gameState !== 'playing' || ball.moving) return;
            
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            
            // Проверяем, началось ли касание на мяче
            const dist = Math.sqrt(
                Math.pow(touch.clientX - ball.x, 2) + 
                Math.pow(touch.clientY - ball.y, 2)
            );
            
            if (dist <= ball.radius * 2) {
                startCharging();
            }
        }
        
        function handleTouchMove(e) {
            if (!isCharging) return;
            
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            
            // Записываем вектор свайпа
            swipeVector = {
                x: touch.clientX - touchStartX,
                y: touch.clientY - touchStartY
            };
        }
        
        function handleTouchEnd(e) {
            if (!isCharging) return;
            
            e.preventDefault();
            stopCharging();
        }
        
        // Обработчики кнопок
        difficultyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                difficultyBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                difficulty = btn.dataset.difficulty;
                
                // Сохраняем выбранную сложность
                localStorage.setItem('penaltyDifficulty', difficulty);
            });
        });
        
        startBtn.addEventListener('click', () => {
            gameState = 'playing';
            menu.style.opacity = '0';
            
            setTimeout(() => {
                menu.style.display = 'none';
                initGame();
            }, 300);
        });
        
        restartBtn.addEventListener('click', () => {
            gameState = 'playing';
            resultScreen.style.opacity = '0';
            
            setTimeout(() => {
                resultScreen.style.display = 'none';
                initGame();
            }, 300);
        });
        
        menuBtn.addEventListener('click', () => {
            gameState = 'menu';
            resultScreen.style.opacity = '0';
            
            setTimeout(() => {
                resultScreen.style.display = 'none';
                menu.style.display = 'flex';
                setTimeout(() => { menu.style.opacity = '1'; }, 10);
            }, 300);
        });
        
        // Обработчик клавиатуры (для отладки)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyD') {
                debugMode = !debugMode;
                debugInfo.style.display = debugMode ? 'block' : 'none';
            } else if (e.code === 'KeyT') {
                showTutorial = !showTutorial;
                tutorial.style.display = showTutorial ? 'block' : 'none';
            }
        });
        
        // Инициализация при загрузке
        window.addEventListener('load', () => {
            resizeCanvas();
            
            // Загружаем сохраненную сложность
            const savedDifficulty = localStorage.getItem('penaltyDifficulty');
            if (savedDifficulty) {
                difficulty = savedDifficulty;
                document.querySelector(`.difficulty-btn[data-difficulty="${savedDifficulty}"]`).classList.add('selected');
            }
            
            // Запускаем игровой цикл
            lastFrameTime = Date.now();
            gameLoop();
            
            // PWA: Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('Ошибка регистрации Service Worker:', err);
                });
            }
        });
        
        window.addEventListener('resize', resizeCanvas);
        
        // Обработчики касаний для canvas
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('touchend', handleTouchEnd);
        
        // Обработчики мыши для десктопа
        canvas.addEventListener('mousedown', handleTouchStart);
        canvas.addEventListener('mousemove', handleTouchMove);
        canvas.addEventListener('mouseup', handleTouchEnd);
        canvas.addEventListener('mouseleave', handleTouchEnd);
    </script>
</body>
</html>
